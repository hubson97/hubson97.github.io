<!DOCTYPE html>
<html>
<head>
    <title>PUM lab5</title>
</head>
<body>

    <canvas height="600" width="800" id="myCanvas"></canvas>
    
    
    <script>
        let points = 0;

        let posX = 400;
        const posY = 470; 
        const carWidth = 80;
        const carHeight = 100;
        const bulletWidth = 10;
        const bulletHeight = 10;

        let speedItems = 2;


        const canvas = document.getElementById("myCanvas");
        const context = canvas.getContext("2d");

        canvas.style.background = "grey";

        const bullets = [];
        const opponents = [];
        const bonuses = [];
        
     
        setInterval(() => {

            drawRectangle();

            collisionsChecking();          
            showPoints();  
            
        }, 10);

        setInterval(() => {
            addOpponent(350,0,20,65,speedItems,false);
        }, 2000);

        setInterval(() => {
            addOpponent(100,-3,20,50,speedItems,false);
            addOpponent(600,-3,20,50,speedItems,false);
        }, 400);

        setInterval(() => {
            addOpponent(getRandomInt(150,550),0,carWidth,carHeight,speedItems,true);
        }, 9000);

        setInterval(() => {
            addBonus(getRandomInt(150,550),0,30,30,speedItems);
        }, 6500);


        function drawRectangle() {
            context.clearRect(0, 0, canvas.width, canvas.height);

            context.beginPath();
            context.rect(100,0,20,600);
            context.fillStyle="red";
            context.fill();
            context.stroke();
            context.closePath();

            context.beginPath();
            context.rect(600,0,20,600);
            context.fillStyle="red";
            context.fill();
            context.stroke();
            context.closePath();

            bullets.forEach((bullet)=>{
                bullet.showBullet();
            })

            
            opponents.forEach((opponent)=>{
                opponent.showOpponent();
            })
            
            bonuses.forEach((bonus)=>{
                bonus.showBonus();
            })

            //LP
            context.beginPath();
            context.arc(posX+8,posY+20, 15,0,2 * Math.PI);
            context.fillStyle="black";
            context.fill();
            context.stroke();
            context.closePath();

            //PP
            context.beginPath();
            context.arc(posX+carWidth-8,posY+20, 15,0,2 * Math.PI);
            context.fillStyle="black";
            context.fill();
            context.stroke();
            context.closePath();

            //LT
            context.beginPath();
            context.arc(posX+8,posY+75, 15,0,2 * Math.PI);
            context.fillStyle="black";
            context.fill();
            context.stroke();
            context.closePath();

            //PT
            context.beginPath();
            context.arc(posX+carWidth-8,posY+75, 15,0,2 * Math.PI);
            context.fillStyle="black";
            context.fill();
            context.stroke();
            context.closePath();


            context.beginPath();
            context.rect(posX,posY,carWidth,carHeight);
            context.fillStyle="red";
            context.fill();
            context.stroke();
            context.closePath();


        }

        window.addEventListener("keydown", keysPressed, false);
        window.addEventListener("keyup", keysReleased, false);
        
        var keys = [];
        
        function keysPressed(e) {
            
            keys[e.keyCode] = true;
        
            // left
            if (keys[37]) {
                posX -= 15;
            }
        
            // right
            if (keys[39]) {
                posX += 15;
            }
            
            //space
            if(keys[32]){
                bullets.push(new Bullet());
            }
        
            //up
            if(keys[38]){
                speedUpItems();
            }

            //down
            if(keys[40]){
                speedDownItems();
            }

            e.preventDefault();
                    
        }
        
        function  speedUpItems(){
            speedItems += 0.1;
        }
        
        function  speedDownItems(){
            speedItems -= 0.1;
        }

        function keysReleased(e) {
            keys[e.keyCode] = false;
        }   

        function addOpponent(objX,objY,objWidth,objHeight,objSpeed,objIsObstacle) {
            opponents.push(new Opponent(objX,objY,objWidth,objHeight,objSpeed,objIsObstacle));
        }
        function addBonus(objX,objY,objWidth,objHeight,objSpeed,objIsObstacle) {
            bonuses.push(new Bonus(objX,objY,objWidth,objHeight,objSpeed));
        }

        function deleteOpponent(opponent){
            const id = opponents.indexOf(opponent);
            opponents.splice(id, 1);
            delete opponent;
        }

        function deleteBonus(bonus){
            const id = bonuses.indexOf(bonus);
            bonuses.splice(id, 1);
            delete bonus;
        }

        function deleteBullet(bullet) {
            const id = bullets.indexOf(bullet);
            bullets.splice(id, 1);
            delete projectile;
        }

        function collisionsChecking(){
            opponents.forEach((opponent) => {
                if(opponent.getIsObstacle())
                {   
                    if(
                    posX < opponent.getX() + opponent.width &&
                    posX + carWidth > opponent.getX() &&
                    posY < opponent.getY() + opponent.height &&
                    carHeight + posY > opponent.getY()
                    )
                    {
                        alert('Przegrałeś!');
                        deleteOpponent(opponent);
                    }
                    
                    bullets.forEach((bullet)=>{
                        if(
                            bullet.getX() < opponent.getX() + opponent.width &&
                            bullet.getX() + bulletWidth > opponent.getX() &&
                            bullet.getY() < opponent.getY() + opponent.height &&
                            bulletWidth + bullet.getY() > opponent.getY()
                        )
                        {
                            deleteOpponent(opponent);
                            deleteBullet(bullet);
                        }
                    })
                }
            });

            bonuses.forEach((bonus)=>{
                if(
                    posX < bonus.getX() + bonus.width &&
                    posX + carWidth > bonus.getX() &&
                    posY < bonus.getY() + bonus.height &&
                    carHeight + posY > bonus.getY()
                    )
                    {
                        points++;
                        deleteBonus(bonus);
                    }
            });

        }


        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
        }

        function showPoints() {
            context.font = "55px serif";
            context.fillText(points, 5, 40);
        }

        class Opponent{
            constructor(objX,objY,objWidth,objHeight,objSpeed,objIsObstacle){
                this.oppoX = objX;//350;//getRandomInt(20, 800);
                this.oppoY = objY;//25;
                this.width = objWidth;
                this.height= objHeight;
                this.speed = objSpeed;
                this.isObstacle = objIsObstacle;
            }


            moveOpponent(){
                this.oppoY +=this.speed;
            }

            showOpponent(){
                context.beginPath();
                this.moveOpponent();
                context.fillStyle = "white";
                context.rect(this.oppoX,this.oppoY,this.width,this.height); //17/65
                context.fill();
                context.stroke();
                context.closePath();
            }

            getIsObstacle(){
                return this.isObstacle;
            }

            getY() {
                return this.oppoY;
            }

            getX() {
                return this.oppoX;
            }

        }

        class Bonus{
            constructor(objX,objY,objWidth,objHeight,objSpeed){
                this.bonX = objX;//350;//getRandomInt(20, 800);
                this.bonY = objY;//25;
                this.width = objWidth;
                this.height= objHeight;
                this.speed = objSpeed;
            }


            moveBonus(){
                this.bonY +=this.speed;
            }

            showBonus(){
                context.beginPath();
                this.moveBonus();
                context.fillStyle = "blue";
                context.rect(this.bonX,this.bonY,this.width,this.height); //17/65
                context.fill();
                context.stroke();
                context.closePath();
            }

         

            getY() {
                return this.bonY;
            }

            getX() {
                return this.bonX;
            }

        }


        class Bullet{

            constructor(){
                this.bulletX = posX + carWidth / 2;
                this.bulletY = posY;
                this.radius = 5;
            }

            
            moveBullet(){
                this.bulletY -= 5;
            }

            showBullet(){
                context.beginPath();
                this.moveBullet();
                context.fillStyle = "black";
                context.rect(this.bulletX,this.bulletY, bulletWidth,bulletHeight);
                context.fill();
                context.stroke();
                context.closePath();
            }

            getRadius() {
                return this.radius;
            }

            getY() {
                return this.bulletY;
            }

            getX() {
                return this.bulletX;
            }


        }

    </script>


</body>
</html>